name: Stability Scan (v2.0)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'sparks/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  stability-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Note: We don't need heavy dependencies yet because our new script 
      # uses standard library re and os for efficiency.
      - name: Get changed spark files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          # Look for any .md file in sparks/
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- sparks/*.md | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Run Stability Scan
        id: scan
        if: steps.changed-files.outputs.files != ''
        run: |
          OUTPUT_FILE="scan_results.txt"
          touch $OUTPUT_FILE
          # Using new Scribe v2.0 stability auditor
          python3 scribe/logic/stability_audit.py --dir sparks/ --json > $OUTPUT_FILE 2>&1
          # Save path for the next step
          echo "output_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT

      - name: Post Stability Report
        if: steps.changed-files.outputs.files != '' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'scan_results.txt';
            let scanOutput = '‚ö†Ô∏è No stability data generated.';
            
            if (fs.existsSync(path)) {
              scanOutput = fs.readFileSync(path, 'utf8');
            }
            
            const comment = `## üß± TheCommons Stability Report
            
            The **AI Scribe** has inspected your contribution for structural integrity.
            
            ### üõ†Ô∏è Inspection Results:
            \`\`\`text
            ${scanOutput}
            \`\`\`
            
            ---
            **Next Steps:**
            * **Green (Stable):** Your brick is ready for the baseplate!
            * **Yellow (Wobbly):** Add missing @handles or fill out required Phase sections.
            * **Red (Unstable):** Ensure your file follows the \`spark_template.md\` format.
            
            *Remember: Intuition earns 5 CS, Imagination earns 15 CS, and Logic earns 25 CS.*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });