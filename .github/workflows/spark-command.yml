name: Spark Command

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  spark-scan:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '!SPARK')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head # Checkout the PR head for analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch base branch and get changed files
        id: changed-files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get base branch name
          base_ref=$(gh pr view ${{ github.event.issue.number }} --json baseRefName --jq .baseRefName)
          echo "Base branch is $base_ref"
          git fetch origin $base_ref --depth=1
          
          # Get list of changed files in sparks/ directory
          CHANGED_FILES=$(git diff --name-only origin/$base_ref...HEAD -- sparks/*.md | tr '\n' ' ')
          
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Run Novelty Scan
        id: scan
        if: steps.changed-files.outputs.files != ''
        run: |
          OUTPUT_FILE=$(mktemp)
          for file in ${{ steps.changed-files.outputs.files }}; do
            if [ -f "$file" ]; then
              python3 scripts/novelty_scan.py --file "$file" | tee -a "$OUTPUT_FILE"
            fi
          done
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        if: steps.changed-files.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outputFile = '${{ steps.scan.outputs.output_file }}';
            let scanOutput = '✅ No output generated';
            
            if (fs.existsSync(outputFile)) {
              scanOutput = fs.readFileSync(outputFile, 'utf8');
            }
            
            const comment = `## ⚡ Spark Command Execution
            
            **Changed Spark Files:** \`${{ steps.changed-files.outputs.files }}\`
            
            ### Scan Output:
            \`\`\`
            ${scanOutput}
            \`\`\`
            
            ---
            *Triggered by !SPARK command.*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Add label
            try {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['spark']
              });
            } catch (error) {
              console.log('Error adding label: ' + error.message);
            }

      - name: Handle No Changes
        if: steps.changed-files.outputs.files == ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "⚠️ No modified spark files found in this PR. Make sure you edited a file in `sparks/` directory."
            });
