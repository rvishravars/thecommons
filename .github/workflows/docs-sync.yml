name: Documentation Sync Check (v2.0)

on:
  pull_request:
    paths:
      - '**.md'
      - 'docs/**.md'
      - 'templates/**.md'
      - 'README.md'

jobs:
  sync-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Cross-References
        run: |
          echo "üîç Checking LEGO Framework synchronization..."
          
          ISSUES=0
          
          # 1. Version Sync Check
          # Looks for "Master Framework (v2.0)" style strings
          MANIFESTO_VERSION=$(grep -oP 'Master Framework \(v\K[0-9.]+' README.md | head -1)
          
          if [ -z "$MANIFESTO_VERSION" ]; then
            echo "‚ùå Could not find version string in README.md"
            ISSUES=$((ISSUES + 1))
          else
            echo "‚úÖ Detected Framework Version: v$MANIFESTO_VERSION"
          fi
          
          # 2. Concept Alignment (The LEGO Trinity)
          # We check that the new v2.0 vocabulary is consistent across the project
          CORE_CONCEPTS=("Intuition" "Imagination" "Logic" "Clutch Power" "Novel Core" "Scout" "Designer" "Builder")
          
          for concept in "${CORE_CONCEPTS[@]}"; do
            if ! grep -qi "$concept" README.md; then
              echo "‚ö†Ô∏è  Core concept '$concept' is missing from README.md - ensure the 'LEGO' terminology is updated."
            fi
          done
          
          # 3. Reference Validation (Link Checker)
          echo ""
          echo "üîó Validating Internal Snap-Points (Links)..."
          
          # Find all markdown files, excluding hidden dirs
          find . -name "*.md" -not -path "*/.*" | while read -r file; do
            # Extract links: [text](link)
            grep -oP '\[.*?\]\(\K[^)]+' "$file" | while read -r link; do
              # Skip external URLs, anchors, and mailto
              if [[ $link != http* ]] && [[ $link != \#* ]] && [[ $link != mailto* ]]; then
                # Clean the link (remove anchors from filename)
                target_base=$(echo "$link" | cut -d'#' -f1)
                
                # Check if the file exists relative to the current file's directory
                file_dir=$(dirname "$file")
                if [ -n "$target_base" ] && [ ! -f "$file_dir/$target_base" ] && [ ! -f "$target_base" ]; then
                  echo "‚ö†Ô∏è  Broken snap-point in $file: $link (Target not found)"
                fi
              fi
            done
          done
          
          if [ $ISSUES -gt 0 ]; then
            echo ""
            echo "‚ùå Found $ISSUES critical documentation sync issues."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Documentation sync validated for v$MANIFESTO_VERSION"